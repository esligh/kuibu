package com.kuibu.ui.activity;

import java.io.File;
import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.json.JSONException;
import org.json.JSONObject;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import us.feras.mdv.MarkdownView;
import android.annotation.SuppressLint;
import android.annotation.TargetApi;
import android.app.AlertDialog;
import android.app.AlertDialog.Builder;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.SharedPreferences;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.preference.PreferenceManager;
import android.support.v4.content.ContextCompat;
import android.support.v7.app.AppCompatActivity;
import android.text.TextUtils;
import android.util.JsonReader;
import android.util.JsonToken;
import android.util.Log;
import android.view.GestureDetector;
import android.view.GestureDetector.OnGestureListener;
import android.view.Menu;
import android.view.MenuItem;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnClickListener;
import android.webkit.JsResult;
import android.webkit.ValueCallback;
import android.webkit.WebChromeClient;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ScrollView;
import android.widget.Toast;

import com.android.volley.AuthFailureError;
import com.android.volley.DefaultRetryPolicy;
import com.android.volley.Response;
import com.android.volley.VolleyError;
import com.android.volley.VolleyLog;
import com.android.volley.toolbox.JsonObjectRequest;
import com.kuibu.app.module.core.DownloadWebImgTask;
import com.kuibu.app.module.core.InJavaScriptObject;
import com.kuibu.common.utils.AssetsUtils;
import com.kuibu.common.utils.DataUtils;
import com.kuibu.common.utils.KuibuUtils;
import com.kuibu.common.utils.NetUtils;
import com.kuibu.common.utils.PreferencesUtils;
import com.kuibu.custom.widget.FButton;
import com.kuibu.custom.widget.MultiStateView;
import com.kuibu.custom.widget.NotifyingScrollView;
import com.kuibu.data.global.Constants;
import com.kuibu.data.global.KuibuApplication;
import com.kuibu.data.global.Session;
import com.kuibu.data.global.StaticValue;
import com.kuibu.module.activity.R;
import com.kuibu.module.iterfaces.OnPageLoadFinished;
import com.kuibu.module.iterfaces.ResponseListener;
import com.nostra13.universalimageloader.core.ImageLoader;
import com.petebevin.markdown.MarkdownProcessor;


public class CollectionDetailActivity extends AppCompatActivity 
		implements OnPageLoadFinished {
	//手指在屏幕滑动，X轴最小变化值
	private static final int FLING_MIN_DISTANCE_X = 200;
	//手指在屏幕滑动，Y轴最小变化值
	private static final int FLING_MIN_DISTANCE = 10;	
	//手指在屏幕滑动，最小速度
	private static final int FLING_MIN_VELOCITY = 1;
		
	private static final short ALPHA_MAX = 255 ; 
	private GestureDetector mGestureDetector;
    private Drawable mActionBarBackgroundDrawable;
    private MarkdownView contentView ; 
    private MenuItem mFavActionItem ,mReportItem;
	private boolean isInFavorite = false;
	private boolean isSupport = false; 
	private String cid ,cisn,createBy; 
	private String cssFile ; 
	private MultiStateView mMultiStateView;
	private FButton likeBtn , commentBtn ;
	private LinearLayout layoutTools; 
	private Handler mHandler  ; 
	private ImageView mHeaderImage ; 
	private int curAlpha;
	private ArrayList<String> mDetailImageList = new ArrayList<String>();
	private boolean isDarkTheme ; 
	private LinearLayout webViewContainer ; 
	private int messageCode ; 
	private int commentCount ; 
	private int voteCount ; 
	private DownloadWebImgTask downLoadTask ; 
	private boolean bReport =false ; 
	
    @SuppressWarnings("deprecation")
	@SuppressLint("HandlerLeak")
	@Override
    public void onCreate(Bundle savedInstanceState) {				
        super.onCreate(savedInstanceState);
		mGestureDetector = new GestureDetector(this, mOnGestureListener);
        setContentView(R.layout.collection_detail_activity);
        webViewContainer = (LinearLayout)findViewById(R.id.content_ll);
        contentView = new MarkdownView(getApplicationContext());
        webViewContainer.addView(contentView);        
        mHeaderImage = (ImageView)findViewById(R.id.image_header);        
        mHandler = new Handler() {  
            @Override  
            public void handleMessage(Message msg) { //no leak,I know .   
                super.handleMessage(msg);  
                switch (msg.what) {  
                	case StaticValue.MSG_CODE.SHOW_TOOLS:                
						layoutTools.setVisibility(View.VISIBLE);  
						mFavActionItem.setVisible(true);
						mReportItem.setVisible(true);
						break; 	 
                	case StaticValue.MSG_CODE.HIDE_TOOLS:
                		layoutTools.setVisibility(View.GONE);
                		mFavActionItem.setVisible(false);
                		mReportItem.setVisible(false);
                		break;
                }  
            }  
        };  
        
        mMultiStateView = (MultiStateView)findViewById(R.id.multiStateView);
		mMultiStateView.getView(MultiStateView.ViewState.ERROR).findViewById(R.id.retry)
        .setOnClickListener(new View.OnClickListener() {
			@Override
			public void onClick(View arg88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888u0) {
				mMultiStateView.setViewState(MultiStateView.ViewState.LOADING);
				loadContent();
			}   	
        });
		likeBtn = (FButton) findViewById(R.id.like_bt);
		likeBtn.setOnClickListener(new OnClickListener() {			
			@Override
			public void onClick(View arg0) {				
				if(Session.getSession().isLogin()){
					doVote(StaticValue.USER_ACTION.ACTION_VOTE_COLLECTION, isSupport);
				}else{
					Toast.makeText(CollectionDetailActivity.this, getString(R.string.need_login), Toast.LENGTH_SHORT).show();
				}
			}
		});
		commentBtn = (FButton)findViewById(R.id.comment_bt);
		commentBtn.setOnClickListener(new OnClickListener(){
			@Override
			public void onClick(View arg0) {
				Intent intent = new Intent(CollectionDetailActivity.this,CommentActivity.class);
				intent.putExtra(StaticValue.SERMODLE.COLLECTION_ID, cid);
				intent.putExtra("create_by", createBy);
				intent.putExtra("commont_count", commentCount);
				startActivityForResult(intent, StaticValue.RequestCode.COMMENT_OVER);
				overridePendingTransition(R.anim.anim_slide_in_left,R.anim.anim_slide_out_left);
			}			
			
		});
		layoutTools = (LinearLayout)findViewById(R.id.layout_tools);
        NotifyingScrollView scrollView = (NotifyingScrollView)findViewById(R.id.scroll_view);       	
		isDarkTheme= PreferencesUtils.getBooleanByDefault(this,StaticValue.PrefKey.DARK_THEME_KEY, false);
		if(isDarkTheme){			
			scrollView.setBackgroundColor(getResources().getColor(R.color.webview_dark));
			mMultiStateView.setBackgroundColor(getResources().getColor(R.color.list_view_bg_dark));
			cssFile = Constants.WEBVIEW_DARK_CSSFILE;
			mActionBarBackgroundDrawable = getResources().getDrawable(R.drawable.abc_ab_solid_dark_holo);
		}else{
			scrollView.setBackgroundColor(getResources().getColor(R.color.webview_light));
			mMultiStateView.setBackgroundColor(getResources().getColor(R.color.white));
			cssFile = Constants.WEBVIEW_LIGHT_CSSFILE;
			mActionBarBackgroundDrawable = getResources().getDrawable(R.drawable.actionbar_background_light);			
		}
		
        getSupportActionBar().setBackgroundDrawable(mActionBarBackgroundDrawable);
        scrollView.setOnScrollChangedListener(mOnScrollChangedListener);      
        getSupportActionBar().setDisplayHomeAsUpEnabled(true);
        setUpWebViewDefaults();
        cid = getIntent().getStringExtra(StaticValue.SERMODLE.COLLECTION_ID);
        cisn = getIntent().getStringExtra(StaticValue.SERMODLE.COLLECTION_CISN);
   /**
    * 缓存content需要考虑更多的同步问题，比如点赞，评论的数目更新问题*/
//        JSONObject cacheObj = KuibuApplication.getCacheInstance().getAsJSONObject(cisn);
//        if(cacheObj != null){
//        	readFromJson(cacheObj);
//        }else{
        	loadContent();
//       }          
        if(Session.getSession().isLogin())
        	loadActions();
    }

    
	@SuppressLint("SetJavaScriptEnabled")
	private void setUpWebViewDefaults()
	{
		contentView.setBackgroundColor(0);
		contentView.getSettings().setJavaScriptEnabled(true);
		contentView.getSettings().setJavaScriptCanOpenWindowsAutomatically(true);
		InJavaScriptObject jsObj = new InJavaScriptObject(this);
		jsObj.setOnPageLoadFinishedListener(this);
		contentView.addJavascriptInterface(jsObj, "injectedObject");
		contentView.setWebViewClient(new WebViewClient(){
			@Override
			public boolean shouldOverrideUrlLoading(WebView view, String url) {   
				 Intent i = new Intent(Intent.ACTION_VIEW,Uri.parse(url));
				 
				 startActivity(i);
		         return true;
		    }  
			@Override
			public void onPageFinished(WebView view, String url) {
				super.onPageFinished(view, url);
				String urlStrArray[] = new String[mDetailImageList.size()];
				mDetailImageList.toArray(urlStrArray);
				if(PreferencesUtils.getBooleanByDefault(CollectionDetailActivity.this, 
						StaticValue.PrefKey.NO_PICTRUE_KEY, false)){//无图
					
				}else{
					downLoadTask = (DownloadWebImgTask) new DownloadWebImgTask(getApplicationContext(),new ResponseListener(){

						@Override
						public void onPreExecute() {
							
						}
						
						@SuppressLint("NewApi")
						@Override
						public void onPostExecute(String content) {
							// TODO Auto-generated method stub
							String javascript = "img_replace_all();";
							
							if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
								// In KitKat+ you should use the evaluateJavascript method
								contentView.evaluateJavascript(javascript, new ValueCallback<String>() {
					                @TargetApi(Build.VERSION_CODES.HONEYCOMB)
					                @Override
					                public void onReceiveValue(String s) {
					                    JsonReader reader = new JsonReader(new StringReader(s));
					                    // Must set lenient to parse single values
					                    reader.setLenient(true);
					                    try {
					                        if(reader.peek() != JsonToken.NULL) {
					                            if(reader.peek() == JsonToken.STRING) {
					                                String msg = reader.nextString();
					                                if(msg != null) {
					                               //     Toast.makeText(getActivity(), msg, Toast.LENGTH_LONG).show();
					                                }
					                            }
					                        }
					                    } catch (IOException e) {
					                        Log.e("TAG", "MainActivity: IOException", e);
					                    } finally {
					                        try {
					                            reader.close();
					                        } catch (IOException e) {
					                            // NOOP
					                        }
					                    }
					                }
					            });
							} else {
								contentView.loadUrl( "javascript:" + javascript);
							}
						}

						@SuppressLint("NewApi")
						@Override
						public void onProgressUpdate(String value) {
							String javascript = "img_replace_by_url('" + value + "')";
							if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
								contentView.evaluateJavascript(javascript, new ValueCallback<String>(){
									@Override
									public void onReceiveValue(String s) {
					                    JsonReader reader = new JsonReader(new StringReader(s));
					                    // Must set lenient to parse single values
					                    reader.setLenient(true);
					                    try {
					                        if(reader.peek() != JsonToken.NULL) {
					                            if(reader.peek() == JsonToken.STRING) {
					                                String msg = reader.nextString();
					                                if(msg != null) {
					                                }
					                            }
					                        }
					                    } catch (IOException e) {
					                        Log.e("TAG", "MainActivity: IOException", e);
					                    } finally {
					                        try {
					                            reader.close();
					                        } catch (IOException e) {
					                        }
					                    }
									}
							    	
							    });
							} else {
								contentView.loadUrl("javascript:" + javascript);
							}
						}

						@Override
						public void onFail(Exception e) {
							// TODO Auto-generated method stub
							e.printStackTrace();
						}
						
					}).executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR,urlStrArray);
				}
			}
		});
		contentView.setWebChromeClient(new WebChromeClient() {			 
		    @Override
		    public boolean onJsAlert(WebView view, String url, String message,
		            final JsResult result) {  
	            result.cancel();  
	            return true; 
		    }		 
		    @Override
		    public boolean onJsConfirm(WebView view, String url,
		            String message, final JsResult result) {
		    	
		        return true;
		    }
		});
		
		int netType = NetUtils.getAPNType(this);
		if(netType == NetUtils.NO_NET){
			contentView.getSettings().setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);
		}else{
			contentView.getSettings().setCacheMode(WebSettings.LOAD_DEFAULT);
		}
		
	}
			
    private NotifyingScrollView.OnScrollChangedListener mOnScrollChangedListener = new NotifyingScrollView.OnScrollChangedListener() {
        public void onScrollChanged(ScrollView who, int l, int t, int oldl, int oldt) {
            final int headerHeight = mHeaderImage.getHeight() - getSupportActionBar().getHeight();
            final float ratio = (float) Math.min(Math.max(t, 0), headerHeight) / headerHeight;
            curAlpha = (int) (ratio * ALPHA_MAX);
            mActionBarBackgroundDrawable.setAlpha(curAlpha);
        }
    };

    @Override
    protected void onDestroy()
    {    	
    	super.onDestroy();
    	if(downLoadTask !=null )
    		downLoadTask.cancel(false);
    	mHandler.removeCallbacksAndMessages(null);
      	webViewContainer.removeView(contentView);
      	contentView.removeAllViews();
      	contentView.destroy();
      	mDetailImageList.clear();
      	mActionBarBackgroundDrawable.setAlpha(ALPHA_MAX);
    }
     
    @Override
    public File getCacheDir()
    {
      return getApplicationContext().getCacheDir();
    }
    
	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		getMenuInflater().inflate(R.menu.content_detail, menu);
		mFavActionItem = menu.findItem(R.id.menu_item_fav_action_bar);
		mReportItem = menu.findItem(R.id.menu_item_report_action_bar);
		mFavActionItem.setVisible(false);
		mReportItem.setVisible(false);
		return true;
	}
	
	@Override
	public boolean onOptionsItemSelected(MenuItem item) {
		switch (item.getItemId()) {
			case android.R.id.home:				
				this.onBackPressed();
				overridePendingTransition(R.anim.anim_slide_out_right, R.anim.anim_slide_in_right);
				break;
			case R.id.menu_item_fav_action_bar:
				if(Session.getSession().isLogin()){
					mActionBarBackgroundDrawable.setAlpha(ALPHA_MAX);
					cid = getIntent().getStringExtra(StaticValue.SERMODLE.COLLECTION_ID);
					Intent intent = new Intent(CollectionDetailActivity.this,CollectFavoriteBoxActivity.class);
					intent.putExtra(StaticValue.SERMODLE.COLLECTION_ID, cid);
					intent.putExtra(StaticValue.COLLECTION.IS_COLLECTED, isInFavorite);
					startActivityForResult(intent,StaticValue.RequestCode.FAVORITE_BOX_REQCODE);
					overridePendingTransition(R.anim.anim_slide_in_left,R.anim.anim_slide_out_left);
				}else{
					Toast.makeText(CollectionDetailActivity.this, getString(R.string.need_login), Toast.LENGTH_SHORT).show();
				}	
				break;
			case R.id.menu_item_report_action_bar:
				if(!bReport){
					doReport();
				}else{
					Toast.makeText(CollectionDetailActivity.this, getString(R.string.have_reported),
							Toast.LENGTH_SHORT).show();
				}
				break;
			case R.id.menu_item_share_action_bar:
				
				Toast.makeText(CollectionDetailActivity.this, "开发中...", Toast.LENGTH_SHORT).show();
				break;
		}
		
		return super.onOptionsItemSelected(item);
	}
	
    @Override
	public boolean dispatchTouchEvent(MotionEvent ev) {
		try {
			mGestureDetector.onTouchEvent(ev);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return super.dispatchTouchEvent(ev);
	}
    
    private OnGestureListener mOnGestureListener = new OnGestureListener() {

		@Override
		public boolean onDown(MotionEvent e) {
			return false;
		}

		@Override
		public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX,
				float velocityY) {
			boolean isXWell = Math.abs(e2.getX() - e1.getX()) < FLING_MIN_DISTANCE_X ? true : false;

			if (isXWell && e1.getY() - e2.getY() > FLING_MIN_DISTANCE && Math.abs(velocityY) > FLING_MIN_VELOCITY) {
				getSupportActionBar().hide();
			} else if (isXWell && e2.getY() - e1.getY() > FLING_MIN_DISTANCE && Math.abs(velocityY) > FLING_MIN_VELOCITY) {
				getSupportActionBar().show();
			}
			return false;
		}
		@Override
		public void onLongPress(MotionEvent e) {			
		}

		@Override
		public boolean onScroll(MotionEvent e1, MotionEvent e2,
				float distanceX, float distanceY) {
			return false;
		}
		
		@Override
		public void onShowPress(MotionEvent e) {
		}
		
		@Override
		public boolean onSingleTapUp(MotionEvent e) {
			return false;
		}
	};

	
	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data)
	{
		switch(requestCode){
			case StaticValue.RequestCode.FAVORITE_BOX_REQCODE:
				if(data!=null){
					isInFavorite = data.getBooleanExtra("isCollected", false);
					if (isInFavorite) {
						Toast.makeText(this, R.string.fav_add_success, Toast.LENGTH_SHORT).show();				
						mFavActionItem.setIcon(R.drawable.ab_fav_active);
						mFavActionItem.setTitle(R.string.actionbar_item_fav_cancel);	
					} else {
						Toast.makeText(this, R.string.fav_cancel_success, Toast.LENGTH_SHORT).show();
						mFavActionItem.setIcon(R.drawable.ab_fav_normal);
						mFavActionItem.setTitle(R.string.actionbar_item_fav_add);				
					}				
				}
				mActionBarBackgroundDrawable.setAlpha(curAlpha);
			break;
			case StaticValue.RequestCode.REPORT_COMPLETE:
				mActionBarBackgroundDrawable.setAlpha(curAlpha);
				if(data!=null){
					bReport = data.getBooleanExtra("is_report", false);
					if(bReport){
						mReportItem.setIcon(R.drawable.ic_action_report_disabled);
					}					
				}
				break;
			case StaticValue.RequestCode.COMMENT_OVER:
				if(data!=null){
					commentCount  = data.getIntExtra("comment_count", 0);
					if(commentCount >0){				
						StringBuilder buff = new StringBuilder(getString(R.string.comment_text))
			        	.append(" ").append(DataUtils.formatNumber(commentCount));
			        	commentBtn.setText(buff.toString());		        	
					}
				}				
				break;
			default:
				break;
		}
		super.onActivityResult(requestCode, resultCode, data);
	}
	
	
	@Override
	protected void onStop() {
		super.onStop();
		KuibuApplication.getInstance().cancelPendingRequests(this);
	}

	@Override
	public void onBackPressed() {
		super.onBackPressed();
	//	 mActionBarBackgroundDrawable.setAlpha(ALPHA_MAX);
		overridePendingTransition(R.anim.anim_slide_out_right, R.anim.anim_slide_in_right);
	}

	@Override
	public void pageLoadFinished() {			
		mHandler.postDelayed(new Runnable() {			
			@Override
			public void run() {
				// TODO Auto-generated method stub
				mHandler.sendEmptyMessage(messageCode);
			}
		}, 200);
	}

	@Override
	public void getHtmlSource(String html) {
	}	    
	
	private String adjustMarkDownText(String markdownText) {
		String pattern = "!\\[.*\\]\\(\\s*(http:.*)\\)";
		Pattern p = Pattern.compile(pattern);
		Matcher m = p.matcher(markdownText);
		StringBuffer sb = new StringBuffer();
		while (m.find()) {
			m.appendReplacement(sb, "\n");		
		}
		m.appendTail(sb);
		return sb.toString();
	}

	private String prepareHeader(JSONObject obj) throws JSONException
	{
		StringBuilder sb = new StringBuilder();
		String url = obj.getString("photo");
		if(TextUtils.isEmpty(url) || url.equals("null")){			
				url = "file:///android_asset/img/default_pic_avata.png";
		}
		sb.append("<div><h2 class=\"headline-title\">").append(obj.getString("title")).append("</h2></div>")
				.append("<div class=\"meta\">")
				.append("<div class=\"author-pic\" ><img class=\"avatar\" style=\"vertical-align:middle\" src=\"").append(url).append("\"></div>")
				.append("<div class=\"author-info\">")
				.append("<span class=\"author\">").append(obj.getString("name")).append("&nbsp;<strong>·</strong></span>")
				.append("<span class=\"bio\">&nbsp;").append(obj.getString("signature")).append("</span>")					
				.append("</div></div>");
		
		String template = AssetsUtils.loadText(this, Constants.TEMPLATE_DEF_URL);
		String html = template.replace("{cssFile}", cssFile);				
		html = html.replace("{place_holder}", sb.toString());
		return html ; 
	}
	
	private void doReport()
	{ 
		AlertDialog.Builder builder =null ; 		
		if(isDarkTheme){
			builder = new Builder(this,AlertDialog.THEME_HOLO_DARK);
		}else{
			builder = new Builder(this,AlertDialog.THEME_HOLO_LIGHT);
		}		
		builder.setTitle(getString(R.string.report_reason));
		builder.setItems(getResources().getStringArray(R.array.report_content), 
				new android.content.DialogInterface.OnClickListener(){
					@Override
					public void onClick(
							DialogInterface dialog,
							int position) {
						Map<String,String> params = new HashMap<String,String>();
						params.put("accuser_id", Session.getSession().getuId());
						params.put("defendant_id", createBy);
						params.put("cid", cid);
						String[] items = getResources().getStringArray(
								R.array.report_content);
						
						if(items!=null && items.length>position)
							params.put("reason",items[position]);
						
						switch(position){
							case 0:	case 1: case 2: case 3: case 4:
								sendReport(params);
								break;
							case 5:
								mActionBarBackgroundDrawable.setAlpha(ALPHA_MAX);
								Intent intent = new Intent(CollectionDetailActivity.this,ReportActivity.class);
								intent.putExtra("defendant", createBy);
								startActivityForResult(intent, StaticValue.RequestCode.REPORT_COMPLETE);							
								break;
						}
					}									
		});
		builder.show();
	}
	
	public void sendReport(Map<String,String> params)
	{
		final String URL = new StringBuilder(Constants.Config.SERVER_URI)
				.append(Constants.Config.REST_API_VERSION)
				.append("/add_report").toString();
		
		JsonObjectRequest req = new JsonObjectRequest(URL, new JSONObject(
				params), new Response.Listener<JSONObject>() {
			@SuppressLint("SimpleDateFormat")
			@Override
			public void onResponse(JSONObject response) {
				try {
					String state = response.getString("state");
					if (StaticValue.RESPONSE_STATUS.OPER_SUCCESS.equals(state)) {
						bReport = true ;
						mReportItem.setIcon(R.drawable.ic_action_report_disabled);
						Toast.makeText(KuibuApplication.getContext(),"感谢您的举报,我们会尽快处理",Toast.LENGTH_SHORT).show();
					}
				} catch (JSONException e) {
					e.printStackTrace();
				}
			}
		}, new Response.ErrorListener() {
			@Override
			public void onErrorResponse(VolleyError error) {
				VolleyLog.e("Error: ", error.getMessage());
				VolleyLog.e("Error:", error.getCause());
				error.printStackTrace();
			}
		}) {
			@Override
			public Map<String, String> getHeaders() throws AuthFailureError {
				return KuibuUtils.prepareReqHeader();
			}
		};
		KuibuApplication.getInstance().addToRequestQueue(req);		
	}

	private String replaceImgTagFromHTML(String html) {
		Document doc = Jsoup.parse(html);
		Elements es = doc.getElementsByTag("img");
		for (Element e : es) {						
			String imgUrl = e.attr("src");			
			mDetailImageList.add(imgUrl);
			if(imgUrl.startsWith(Constants.URI_PREFIX)){
				e.attr("src_link",imgUrl);
			}else{
				String localImgPath = KuibuUtils.getCacheImgFilePath(this, imgUrl);
				e.attr("src_link","file://" + localImgPath);				
			}              
			e.attr("ori_link",imgUrl); 
            if(!e.attr("class").equals("avatar")){
    			e.attr("src","file:///android_asset/img/default_image_loading.png");
    			e.attr("onclick", "openImage('" + imgUrl + "')");
            }			
		}
		return doc.html();
	}
	
	
	private void loadContent()
	{	
		Map<String, String> params = new HashMap<String, String>();
		params.put("cid", cid);
		final String URL = new StringBuilder(Constants.Config.SERVER_URI)
				.append(Constants.Config.REST_API_VERSION) 
				.append("/get_collectiondetail").toString();
		JsonObjectRequest req = new JsonObjectRequest(URL, new JSONObject(
				params), new Response.Listener<JSONObject>() {
			@Override
			public void onResponse(JSONObject response) {
				try {
					String state = response.getString("state");
					if (StaticValue.RESPONSE_STATUS.OPER_SUCCESS.equals(state)) {
						
						JSONObject obj = new JSONObject(response.getString("result"));
						if(obj!=null){							
							readFromJson(obj);		
							if(TextUtils.isEmpty(cisn)){
								cisn = obj.getString("cisn");
							}
							KuibuApplication.getCacheInstance().put(cisn, 
									obj, Constants.Config.CONTENT_CACHE_SAVE_TIME);
						}
					}
				} catch (JSONException e) {
					e.printStackTrace();
				}
			}
		}, new Response.ErrorListener() {
			@Override
			public void onErrorResponse(VolleyError error) {
				VolleyLog.e("Error: ", error.getMessage());
				VolleyLog.e("Error:", error.getCause());
				error.printStackTrace();
				mMultiStateView.setViewState(MultiStateView.ViewState.ERROR);
			}
			
		});
		KuibuApplication.getInstance().addToRequestQueue(req,this);	
	}
	
	private void readFromJson(JSONObject obj)
	{
		try {
			createBy = obj.getString("create_by");
			String uid = Session.getSession().getuId(); 
	        if(uid != null && uid.equals(createBy)){
	        	messageCode = StaticValue.MSG_CODE.HIDE_TOOLS;
	        }else{
	        	messageCode = StaticValue.MSG_CODE.SHOW_TOOLS;
	        }
	        
	        String coverUrl = obj.getString("cover_url");	
	        if(!TextUtils.isEmpty(coverUrl) && !coverUrl.equals("null")){
	        	ImageLoader.getInstance().displayImage(coverUrl,mHeaderImage);
	        }
	     
	        commentCount = obj.getInt("comment_count");
	        if(commentCount>0){
	        	StringBuilder buff = new StringBuilder(getString(R.string.comment_text))
	        	.append(" ").append(DataUtils.formatNumber(commentCount));
	        	commentBtn.setText(buff.toString());
	        }
	        voteCount = obj.getInt("vote_count");
	        if(voteCount > 0){
	        	StringBuilder buff = new StringBuilder(getString(R.string.like))
	        	.append(" ").append(DataUtils.formatNumber(voteCount));
	        	likeBtn.setText(buff.toString());
	        }
			final String template = prepareHeader(obj);
			String type = obj.getString("type");
			String content = obj.getString("content");
			if(StaticValue.EDITOR_VALUE.COLLECTION_TEXTIMAGE.equals(type)){
				SharedPreferences pref = PreferenceManager.getDefaultSharedPreferences(CollectionDetailActivity.this);
				boolean noPic = pref.getBoolean(StaticValue.PrefKey.NO_PICTRUE_KEY, false);
				if(noPic){
					content = adjustMarkDownText(content);
				}
			}
			MarkdownProcessor m = new MarkdownProcessor();
			String html = new String(template);
			StringBuilder footer = new StringBuilder();							
			footer.append("<span class=\"time\">").append("编撰于 ").append(obj.getString("create_time")).append("</span><br>");
			html = html.replace("{footer}", footer.toString());
			content = m.markdown(content);		
			html = html.replace("{content}", content);
			html = replaceImgTagFromHTML(html);
			contentView.loadDataWithBaseURL("http://", html, "text/html", "UTF-8", null);
			mActionBarBackgroundDrawable.setAlpha(0);
			mMultiStateView.setViewState(MultiStateView.ViewState.CONTENT);
		} catch (JSONException e) {
			e.printStackTrace();
			mMultiStateView.setViewState(MultiStateView.ViewState.ERROR);
		}      
	}
	
	private void doVote(String action_type,boolean isChecked)
	{
		Map<String, String> params = new HashMap<String, String>();
		params.put("uid", Session.getSession().getuId());
		params.put("action_type", action_type);
		params.put("obj_id", cid);
		String URL=""; 
		if(!isChecked){
			URL = new StringBuilder(Constants.Config.SERVER_URI)
					.append(Constants.Config.REST_API_VERSION)
					.append("/add_useraction").toString();		
		}else{
			URL = new StringBuilder(Constants.Config.SERVER_URI)
					.append(Constants.Config.REST_API_VERSION)
					.append("/del_useraction").toString();			
		}
		
		JsonObjectRequest req = new JsonObjectRequest(URL, new JSONObject(
				params), new Response.Listener<JSONObject>() {
			@Override
			public void onResponse(JSONObject response) {
				try {
					String state = response.getString("state");
					if (StaticValue.RESPONSE_STATUS.OPER_SUCCESS.equals(state)) {
						Drawable drawable = null ; 
						if (isSupport) {
							voteCount -= 1; 
							drawable= ContextCompat.getDrawable(KuibuApplication.getContext(),
									R.drawable.ab_support_normal);												
							isSupport = false;						
						} else {
							voteCount += 1; 
							drawable= ContextCompat.getDrawable(KuibuApplication.getContext(),
									R.drawable.ab_support_active);
							isSupport = true;				
						}
						drawable.setBounds(0, 0, drawable.getIntrinsicWidth(), drawable.getIntrinsicHeight());
						likeBtn.setCompoundDrawables(drawable, null, null, null);
						
						if(voteCount > 0){
							StringBuilder buff = new StringBuilder(getString(R.string.like))
				        	.append(" ").append(DataUtils.formatNumber(voteCount));
				        	likeBtn.setText(buff.toString());
						}						
					}
				} catch (JSONException e) {
					e.printStackTrace();
				}
			}
		}, new Response.ErrorListener() {
			@Override
			public void onErrorResponse(VolleyError error) {
				VolleyLog.e("Error: ", error.getMessage());
				VolleyLog.e("Error:", error.getCause());
				error.printStackTrace();
			}
		}){
			@Override
			public Map<String, String> getHeaders() throws AuthFailureError {
				return KuibuUtils.prepareReqHeader();
			}
		};

		req.setRetryPolicy(new DefaultRetryPolicy(Constants.Config.TIME_OUT_LONG,
			Constants.Config.RETRY_TIMES, 1.0f));
		KuibuApplication.getInstance().addToRequestQueue(req,this);
	}
	
	public void loadActions()
	{
		Map<String, String> params = new HashMap<String, String>();
		params.put("uid", Session.getSession().getuId());
		params.put("obj_id", cid);
		final String URL = new StringBuilder(Constants.Config.SERVER_URI)
							.append(Constants.Config.REST_API_VERSION)
							.append("/get_useraction").toString();				
		JsonObjectRequest req = new JsonObjectRequest(URL, new JSONObject(
				params), new Response.Listener<JSONObject>() {
			@Override
			public void onResponse(JSONObject response) {
				try {
					String state = response.getString("state");
					if (StaticValue.RESPONSE_STATUS.OPER_SUCCESS.equals(state)) {
						String astr = response.getString("actions");
						List<String> codes = null; 
						if(!TextUtils.isEmpty(astr)){
							String[] actions = astr.split(",");
							codes = Arrays.asList(actions);
							if(codes.contains(StaticValue.USER_ACTION.ACTION_VOTE_COLLECTION)){
								Drawable drawable= ContextCompat.getDrawable(KuibuApplication.getContext(),
										R.drawable.ab_support_active);
								drawable.setBounds(0, 0, drawable.getIntrinsicWidth(), drawable.getIntrinsicHeight());
								likeBtn.setCompoundDrawables(drawable, null, null, null);
								isSupport = true; 
							}
							if(codes.contains(StaticValue.USER_ACTION.ACTION_COLLECT_COLLECTION)){
								mFavActionItem.setIcon(R.drawable.ab_fav_active);
								mFavActionItem.setTitle(R.string.actionbar_item_fav_cancel);
								isInFavorite = true;
							}
							
							if(codes.contains(StaticValue.USER_ACTION.ACTION_REPORT_COLLECTION)){
								mReportItem.setIcon(R.drawable.ic_action_report_disabled);
								bReport = true ; 								
							}							
						}						
					}
				} catch (JSONException e) {
					e.printStackTrace();
				}
			}
		}, new Response.ErrorListener() {
			@Override
			public void onErrorResponse(VolleyError error) {
				VolleyLog.e("Error: ", error.getMessage());
				VolleyLog.e("Error:", error.getCause());
				error.printStackTrace();
			}
		});
		KuibuApplication.getInstance().addToRequestQueue(req,this);
	}
}
